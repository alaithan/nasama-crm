<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Nasama CRM">
  <meta name="application-name" content="Nasama CRM">
  <meta name="theme-color" content="#0A1628">
  <link rel="manifest" href="manifest.json">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Nasama Properties CRM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Segoe UI',sans-serif;background:#F0F4FA;color:#1a2744}
  :root{--gold:#C9A84C;--dark:#0A1628;--navy:#0D2147}
  .app{display:flex;min-height:100vh}
  /* Sidebar */
  #sidebar{width:220px;background:linear-gradient(180deg,var(--dark),var(--navy));display:flex;flex-direction:column;position:sticky;top:0;height:100vh;transition:width .2s;overflow:hidden;flex-shrink:0}
  #sidebar.collapsed{width:60px}
  .sidebar-logo{padding:18px 14px;border-bottom:1px solid #ffffff14;display:flex;align-items:center;gap:10px;white-space:nowrap}
  .logo-icon{width:34px;height:34px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
  .logo-text{color:#fff;font-weight:800;font-size:.9rem}
  .logo-sub{color:var(--gold);font-size:.65rem;letter-spacing:.1em;text-transform:uppercase}
  nav{flex:1;padding:10px 8px;overflow-y:auto}
  .nav-btn{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:.86rem;font-weight:500;color:#93a3c2;background:transparent;border:none;width:100%;text-align:left;white-space:nowrap;transition:all .15s}
  .nav-btn:hover{color:#fff;background:#ffffff10}
  .nav-btn.active{color:var(--gold);background:#C9A84C18}
  .nav-btn .icon{flex-shrink:0;font-size:1rem}
  .sidebar-foot{padding:10px 8px;border-top:1px solid #ffffff14}
  .user-chip{padding:8px 12px;background:#ffffff0a;border-radius:9px;margin-bottom:6px;white-space:nowrap;overflow:hidden}
  .user-chip .uname{color:#fff;font-size:.82rem;font-weight:600}
  .user-chip .urole{color:var(--gold);font-size:.7rem}
  /* Main */
  #main{flex:1;display:flex;flex-direction:column;min-width:0}
  #topbar{background:#fff;border-bottom:1px solid #e4ebf5;padding:10px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;box-shadow:0 1px 6px #0d21470a}
  .page{padding:24px;flex:1}
  /* Cards */
  .card{background:#fff;border-radius:14px;box-shadow:0 2px 16px #0d214710;padding:20px;border:1px solid #e8edf5;margin-bottom:20px}
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:14px;margin-bottom:22px}
  .stat-card{border-radius:14px;padding:18px 20px;color:#fff}
  .stat-card.gold{background:linear-gradient(135deg,#7a5a1e,var(--gold))}
  .stat-card.dark{background:linear-gradient(135deg,var(--dark),var(--navy))}
  .stat-val{font-size:1.4rem;font-weight:800;line-height:1.1;margin-bottom:4px}
  .stat-lbl{font-size:.72rem;opacity:.75;letter-spacing:.08em;text-transform:uppercase}
  /* Table */
  table{width:100%;border-collapse:collapse}
  th{background:var(--navy);color:#fff;padding:9px 12px;text-align:left;font-weight:600;font-size:.74rem;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap}
  td{padding:9px 12px;border-bottom:1px solid #e4ebf5;font-size:.84rem;vertical-align:middle}
  tr:hover td{background:#f8fafc}
  .overflow{overflow-x:auto}
  /* Inputs */
  input,select,textarea{width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:.86rem;font-family:inherit;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--navy);box-shadow:0 0 0 3px #0d214718}
  label{font-size:.8rem;font-weight:600;color:#374151;display:block;margin-bottom:4px}
  .field{margin-bottom:2px}
  .g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  /* Buttons */
  .btn{padding:7px 16px;border-radius:7px;font-size:.82rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:5px;border:none;transition:opacity .15s}
  .btn:hover{opacity:.85}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn-primary{background:var(--gold);color:#fff}
  .btn-secondary{background:#f1f5f9;color:#334155;border:1px solid #e4ebf5}
  .btn-ghost{background:transparent;color:#64748b;border:1px solid #e4ebf5}
  .btn-edit{background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe}
  .btn-delete{background:#fee2e2;color:#dc2626;border:1px solid #fecaca}
  .btn-danger{background:#fee2e2;color:#dc2626}
  /* Badges */
  .badge{display:inline-block;padding:2px 10px;border-radius:20px;font-size:.72rem;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
  .b-green{background:#dcfce7;color:#16a34a}
  .b-yellow{background:#fef9c3;color:#b45309}
  .b-blue{background:#dbeafe;color:#1d4ed8}
  .b-gray{background:#f1f5f9;color:#64748b}
  .b-red{background:#fee2e2;color:#dc2626}
  .b-purple{background:#ede9fe;color:#7c3aed}
  .b-pink{background:#fce7f3;color:#be185d}
  .b-sky{background:#e0f2fe;color:#0369a1}
  .b-amber{background:#fef3c7;color:#92400e}
  /* Modal */
  .modal-overlay{position:fixed;inset:0;background:#00000070;z-index:100;display:flex;align-items:center;justify-content:center;padding:20px}
  .modal-box{background:#fff;border-radius:16px;max-width:780px;width:100%;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px #00000040}
  .modal-head{background:linear-gradient(135deg,var(--navy),var(--dark));color:#fff;padding:18px 24px;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between}
  .modal-body{padding:24px}
  .save-bar{display:flex;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid #e4ebf5;justify-content:flex-end}
  .comm-box{margin-top:12px;padding:11px 14px;background:#f0fdf4;border-radius:9px;border:1px solid #bbf7d0;font-size:.9rem}
  .comm-box span{font-weight:800;color:#15803d}
  /* Page header */
  .page-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
  .page-title{font-size:1.4rem;font-weight:800;color:var(--dark)}
  .page-title small{font-size:.85rem;color:#64748b;font-weight:400}
  /* Search row */
  .search-row{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
  .search-wrap{position:relative;flex:1;min-width:200px}
  .search-wrap .icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.4}
  .search-wrap input{padding-left:32px}
  /* Alert */
  .alert-bar{background:linear-gradient(90deg,#7c1d1d,#991b1b);color:#fff;padding:9px 16px;border-radius:9px;font-size:.82rem;margin-bottom:7px}
  /* View grid */
  .view-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .view-cell{background:#f8fafc;border-radius:8px;padding:10px 14px}
  .view-cell .vk{font-size:.72rem;color:#64748b;font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:3px}
  .view-cell .vv{font-weight:600;color:var(--dark)}
  /* Charts */
  .chart-grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-bottom:20px}
  .chart-wrap{position:relative;height:180px}
  /* Loading */
  #loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--dark),var(--navy));display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;z-index:999}
  .spinner{width:38px;height:38px;border:4px solid #C9A84C30;border-top:4px solid var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin:20px auto}
  @keyframes spin{to{transform:rotate(360deg)}}
  /* Login */
  #login-screen{position:fixed;inset:0;background:linear-gradient(135deg,var(--dark),var(--navy));display:flex;align-items:center;justify-content:center;z-index:998}
  .login-box{width:400px;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 30px 80px #00000060}
  .login-head{background:linear-gradient(135deg,var(--dark),var(--navy));padding:32px;text-align:center}
  .login-icon{width:56px;height:56px;background:var(--gold);border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:1.5rem;margin-bottom:14px}
  .login-title{font-size:1.5rem;color:#fff;font-weight:800}
  .login-sub{color:#93a3c2;font-size:.8rem;margin-top:6px;letter-spacing:.1em;text-transform:uppercase}
  .login-body{padding:28px 32px}
  .login-err{color:#dc2626;background:#fee2e2;padding:8px 12px;border-radius:7px;font-size:.83rem;margin-bottom:12px}
  .login-hint{margin-top:14px;font-size:.77rem;color:#94a3b8;text-align:center}
  /* hidden */
  .hidden{display:none!important}
  /* chip */
  .chip{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.74rem;font-weight:700}
  .chip-green{background:#dcfce7;color:#16a34a}
  .chip-blue{background:#dbeafe;color:#1d4ed8}
  /* mono */
  .mono{font-family:monospace;font-size:.79rem;color:#64748b}
  /* note box */
  .note-box{margin-top:14px;background:#fef9c3;border-radius:8px;padding:10px 14px;font-size:.85rem}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div style="width:64px;height:64px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin-bottom:16px">ğŸ¢</div>
  <div style="color:#fff;font-weight:800;font-size:1.3rem;margin-bottom:6px">Nasama Properties</div>
  <div style="color:#93a3c2;font-size:.83rem;letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px">Dubai, UAE</div>
  <div class="spinner"></div>
  <div id="loading-msg" style="color:#93a3c2;font-size:.85rem;margin-top:8px">Connecting to databaseâ€¦</div>
</div>

<!-- LOGIN -->
<div id="login-screen" class="hidden">
  <div class="login-box">
    <div class="login-head">
      <div class="login-icon">ğŸ¢</div>
      <div class="login-title">Nasama Properties</div>
      <div class="login-sub">Real Estate Â· Dubai, UAE</div>
    </div>
    <div class="login-body">
      <div class="field" style="margin-bottom:14px"><label>Username</label><input id="li-user" placeholder="e.g. admin" autocomplete="off"/></div>
      <div class="field" style="margin-bottom:18px"><label>Password</label><input id="li-pass" type="password" placeholder="e.g. admin123"/></div>
      <div id="li-err" class="login-err hidden"></div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px" onclick="doLogin()">Sign In â†’</button>
      <div class="login-hint">Demo: <b>admin/admin123</b> Â· <b>ahmed/broker123</b> Â· <b>sarah/broker123</b></div>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app hidden" id="app">
  <div id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">ğŸ¢</div>
      <div><div class="logo-text">Nasama</div><div class="logo-sub">Properties</div></div>
    </div>
    <nav id="nav-items"></nav>
    <div class="sidebar-foot">
      <div class="user-chip" id="user-chip"></div>
      <button class="nav-btn" onclick="logout()"><span class="icon">ğŸšª</span><span class="nav-label">Logout</span></button>
    </div>
  </div>
  <div id="main">
    <div id="topbar">
      <div style="display:flex;align-items:center;gap:12px">
        <button onclick="toggleSidebar()" style="border:none;background:none;cursor:pointer;font-size:1.1rem;color:#64748b">â˜°</button>
        <span id="topbar-date" style="color:#64748b;font-size:.82rem"></span>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <span class="chip chip-green">ğŸŸ¢ Turso DB</span>
        <span id="role-chip" class="chip chip-blue"></span>
        <div id="avatar" style="width:32px;height:32px;background:linear-gradient(135deg,var(--gold),#b8942e);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.85rem"></div>
      </div>
    </div>
    <div class="page" id="page-content"></div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay hidden" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-box">
    <div class="modal-head">
      <span id="modal-title" style="font-size:1.05rem;font-weight:700"></span>
      <button onclick="closeModal()" style="background:#ffffff22;color:#fff;border:none;border-radius:7px;padding:4px 12px;cursor:pointer">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script type="module">
// â”€â”€â”€ TURSO DB CLIENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { createClient } from "https://esm.sh/@libsql/client@0.14.0/web";

const DB_URL   = "libsql://nasama-db2-alaithan.aws-ap-northeast-1.turso.io";
const DB_TOKEN = "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NzIwODg4MjMsImlkIjoiMDE5Yzk4YjktNmIwMS03ZDVhLTgwOGUtZDhkMjUwMjJhNzhlIiwicmlkIjoiMDIwOGJlNWYtZDM3Ny00ZTc2LWEyODQtNmY4NjFlMzZkZDQxIn0.QUGYnl4DTXCLEc5SgiGHr0XWehDvQ8-S6PoSzQdm0iiPFA0K16EXplqlVsjKCKQefgSst7P7ZMb4j3D9HTGtAA";

const db = createClient({ url: DB_URL, authToken: DB_TOKEN });

async function q(sql, args = []) {
  const rs = await db.execute({ sql, args });
  return rs.rows;
}
async function batch(stmts) {
  await db.batch(stmts.map(({ sql, args = [] }) => ({ sql, args })));
}

// â”€â”€â”€ SCHEMA + SEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function initDB() {
  await batch([
    { sql: `CREATE TABLE IF NOT EXISTS brokers (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, nationality TEXT, contact TEXT, rera TEXT, reraExpiry TEXT, status TEXT DEFAULT 'Active', createdAt TEXT DEFAULT (datetime('now')))` },
    { sql: `CREATE TABLE IF NOT EXISTS developers (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, agreement TEXT DEFAULT 'No', agreementExpiry TEXT, status TEXT DEFAULT 'Active', createdAt TEXT DEFAULT (datetime('now')))` },
    { sql: `CREATE TABLE IF NOT EXISTS clients (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, nationality TEXT, contact TEXT, email TEXT, type TEXT, createdAt TEXT DEFAULT (datetime('now')))` },
    { sql: `CREATE TABLE IF NOT EXISTS offplan (id INTEGER PRIMARY KEY AUTOINCREMENT, brokerId INTEGER, clientId INTEGER, developerId INTEGER, status TEXT DEFAULT 'Pending', project TEXT, unit TEXT, price REAL, commPct REAL, invoiceNo TEXT, date TEXT, aml TEXT DEFAULT 'No', kycSent TEXT DEFAULT 'No', kycReceived TEXT DEFAULT 'No', notes TEXT, createdAt TEXT DEFAULT (datetime('now')))` },
    { sql: `CREATE TABLE IF NOT EXISTS secondary (id INTEGER PRIMARY KEY AUTOINCREMENT, brokerId INTEGER, buyerId INTEGER, sellerId INTEGER, developerId INTEGER, status TEXT DEFAULT 'Pending', property TEXT, propNo TEXT, contract TEXT, price REAL, sellerPct REAL, buyerPct REAL, discount REAL DEFAULT 0, invoiceNo TEXT, date TEXT, amlBuyer TEXT DEFAULT 'No', amlSeller TEXT DEFAULT 'No', kycSent TEXT DEFAULT 'No', kycReceived TEXT DEFAULT 'No', createdAt TEXT DEFAULT (datetime('now')))` },
    { sql: `CREATE TABLE IF NOT EXISTS rental (id INTEGER PRIMARY KEY AUTOINCREMENT, brokerId INTEGER, clientId INTEGER, status TEXT DEFAULT 'Active', property TEXT, propNo TEXT, contractType TEXT DEFAULT 'Annual', rent REAL, commPct REAL, invoiceNo TEXT, dateRented TEXT, startDate TEXT, endDate TEXT, pfExpert TEXT DEFAULT 'No', notes TEXT, createdAt TEXT DEFAULT (datetime('now')))` },
  ]);
  const cnt = await q("SELECT COUNT(*) as c FROM brokers");
  if (Number(cnt[0].c) === 0) {
    await batch([
      { sql: `INSERT INTO brokers (name,nationality,contact,rera,reraExpiry,status) VALUES ('Ahmed Al Mansouri','UAE','+971 50 123 4567','RERA-2024-001','2025-12-31','Active')` },
      { sql: `INSERT INTO brokers (name,nationality,contact,rera,reraExpiry,status) VALUES ('Sarah Johnson','UK','+971 55 987 6543','RERA-2024-002','2025-03-15','Active')` },
      { sql: `INSERT INTO brokers (name,nationality,contact,rera,reraExpiry,status) VALUES ('Mohammed Al Rashid','UAE','+971 52 456 7890','RERA-2024-003','2025-08-20','Active')` },
      { sql: `INSERT INTO brokers (name,nationality,contact,rera,reraExpiry,status) VALUES ('Priya Sharma','India','+971 56 321 0987','RERA-2023-015','2024-11-30','Inactive')` },
      { sql: `INSERT INTO developers (name,agreement,agreementExpiry,status) VALUES ('Emaar Properties','Yes','2026-06-30','Active')` },
      { sql: `INSERT INTO developers (name,agreement,agreementExpiry,status) VALUES ('Damac Properties','Yes','2025-12-31','Active')` },
      { sql: `INSERT INTO developers (name,agreement,agreementExpiry,status) VALUES ('Nakheel','Yes','2025-09-15','Active')` },
      { sql: `INSERT INTO developers (name,agreement,agreementExpiry,status) VALUES ('Sobha Realty','No','','Active')` },
      { sql: `INSERT INTO clients (name,nationality,contact,email,type) VALUES ('James Wilson','UK','+44 7700 900000','james@email.com','Buyer')` },
      { sql: `INSERT INTO clients (name,nationality,contact,email,type) VALUES ('Fatima Al Zaabi','UAE','+971 50 111 2222','fatima@email.com','Seller')` },
      { sql: `INSERT INTO clients (name,nationality,contact,email,type) VALUES ('Raj Patel','India','+971 55 333 4444','raj@email.com','Tenant')` },
      { sql: `INSERT INTO clients (name,nationality,contact,email,type) VALUES ('Elena Kozlov','Russia','+971 52 555 6666','elena@email.com','Buyer')` },
      { sql: `INSERT INTO clients (name,nationality,contact,email,type) VALUES ('Michael Chen','China','+971 56 777 8888','mchen@email.com','Landlord')` },
      { sql: `INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (1,1,1,'Closed','Marina Vista','A-1204',2800000,4,'INV-001','2024-11-15','Yes','Yes','Yes','')` },
      { sql: `INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (2,4,2,'Pending','Hills Estate','B-0503',1950000,3.5,'INV-002','2024-12-01','Yes','Yes','No','Awaiting KYC')` },
      { sql: `INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (3,5,3,'Closed','Palm Residences','C-2101',5500000,3,'INV-003','2024-10-20','Yes','Yes','Yes','')` },
      { sql: `INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (1,2,4,'Cancelled','Creek Towers','D-0801',3200000,4,'INV-004','2024-09-05','No','No','No','Deal fell through')` },
      { sql: `INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (2,3,1,'Closed','Downtown Square','E-1505',1200000,4,'INV-005','2025-01-10','Yes','Yes','Yes','')` },
      { sql: `INSERT INTO secondary (brokerId,buyerId,sellerId,developerId,status,property,propNo,contract,price,sellerPct,buyerPct,discount,invoiceNo,date,amlBuyer,amlSeller,kycSent,kycReceived) VALUES (1,1,2,1,'Closed','JBR Apartment','J-305','CON-001',3800000,2,2,0,'SINV-001','2024-11-28','Yes','Yes','Yes','Yes')` },
      { sql: `INSERT INTO secondary (brokerId,buyerId,sellerId,developerId,status,property,propNo,contract,price,sellerPct,buyerPct,discount,invoiceNo,date,amlBuyer,amlSeller,kycSent,kycReceived) VALUES (3,4,5,2,'Pending','DIP Villa','V-102','CON-002',6200000,1.5,2,10000,'SINV-002','2025-01-05','Yes','No','Yes','No')` },
      { sql: `INSERT INTO rental (brokerId,clientId,status,property,propNo,contractType,rent,commPct,invoiceNo,dateRented,startDate,endDate,pfExpert,notes) VALUES (2,3,'Active','Marina Heights','MH-401','Annual',85000,5,'RINV-001','2024-06-01','2024-06-01','2025-05-31','Yes','')` },
      { sql: `INSERT INTO rental (brokerId,clientId,status,property,propNo,contractType,rent,commPct,invoiceNo,dateRented,startDate,endDate,pfExpert,notes) VALUES (1,5,'Active','JVC Studio','JS-210','Annual',42000,5,'RINV-002','2024-09-15','2024-09-15','2025-09-14','No','')` },
      { sql: `INSERT INTO rental (brokerId,clientId,status,property,propNo,contractType,rent,commPct,invoiceNo,dateRented,startDate,endDate,pfExpert,notes) VALUES (3,1,'Expired','Downtown Loft','DL-809','Short Term',12000,8,'RINV-003','2024-01-01','2024-01-01','2024-12-31','Yes','Renewal in progress')` },
      { sql: `INSERT INTO rental (brokerId,clientId,status,property,propNo,contractType,rent,commPct,invoiceNo,dateRented,startDate,endDate,pfExpert,notes) VALUES (2,1,'Active','Business Bay Apt','BB-605','Annual',110000,5,'RINV-004','2025-01-20','2025-01-20','2026-01-19','Yes','')` },
    ]);
  }
}

// â”€â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt    = n => new Intl.NumberFormat("en-AE").format(Math.round(Number(n)||0));
const fmtAED = n => `AED ${fmt(n)}`;
const today  = new Date();
const daysUntil = d => { if(!d)return 9999; return Math.ceil((new Date(d)-today)/86400000); };
const commOP  = d => (n(d.price)*n(d.commPct))/100;
const commSel = d => (n(d.price)*n(d.sellerPct))/100;
const commBuy = d => (n(d.price)*n(d.buyerPct))/100;
const commSec = d => commSel(d)+commBuy(d)-n(d.discount);
const commR   = d => (n(d.rent)*n(d.commPct))/100;
const commVAT = d => commR(d)*0.05;
const commRT  = d => commR(d)+commVAT(d);
const n = v => Number(v)||0;
const id3 = (pre,id) => `${pre}-${String(id).padStart(3,"0")}`;
const esc = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");

const BADGE = {
  Active:"b-green",Closed:"b-green",Renewed:"b-green",
  Pending:"b-yellow",Yes:"b-blue",Inactive:"b-gray",
  Cancelled:"b-red",Expired:"b-red",No:"b-gray",
  Buyer:"b-purple",Seller:"b-pink",Tenant:"b-sky",Landlord:"b-amber"
};
const badge = v => `<span class="badge ${BADGE[v]||'b-gray'}">${esc(v)}</span>`;

const renewalDate = d => { if(!d.endDate)return "â€”"; const e=new Date(d.endDate); e.setDate(e.getDate()-90); return e.toISOString().split("T")[0]; };

// â”€â”€â”€ APP STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let CU = null; // current user
let DATA = { brokers:[], developers:[], clients:[], offplan:[], secondary:[], rental:[] };

const USERS = [
  { username:"admin",  password:"admin123",  role:"Admin",  name:"Admin User",        brokerId:null },
  { username:"ahmed",  password:"broker123", role:"Broker", name:"Ahmed Al Mansouri", brokerId:1 },
  { username:"sarah",  password:"broker123", role:"Broker", name:"Sarah Johnson",     brokerId:2 },
];

const NAV = [
  { key:"dashboard", label:"Dashboard",  icon:"ğŸ ", admin:false },
  { key:"brokers",   label:"Brokers",    icon:"ğŸ‘¤", admin:true  },
  { key:"developers",label:"Developers", icon:"ğŸ—", admin:true  },
  { key:"clients",   label:"Clients",    icon:"ğŸ‘¥", admin:false },
  { key:"offplan",   label:"Off Plan",   icon:"ğŸ“‹", admin:false },
  { key:"secondary", label:"Secondary",  icon:"ğŸ”„", admin:false },
  { key:"rental",    label:"Rental",     icon:"ğŸ ", admin:false },
  { key:"reports",   label:"Reports",    icon:"ğŸ“Š", admin:false },
  { key:"settings",  label:"Settings",   icon:"âš™ï¸", admin:true  },
];

let currentPage = "dashboard";
let sidebarOpen = true;
let chartInstances = {};

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    setMsg("Initializing schemaâ€¦");
    await initDB();
    setMsg("Loading dataâ€¦");
    await loadAll();
    hide("loading-screen");
    show("login-screen");
  } catch(e) {
    document.getElementById("loading-msg").textContent = "âŒ " + e.message;
    document.getElementById("loading-msg").style.color = "#f87171";
    const btn = document.createElement("button");
    btn.className = "btn btn-primary"; btn.style.marginTop = "16px";
    btn.textContent = "ğŸ”„ Retry"; btn.onclick = () => location.reload();
    document.getElementById("loading-screen").appendChild(btn);
  }
}

function setMsg(t) { document.getElementById("loading-msg").textContent = t; }

async function loadAll() {
  const [b,dev,c,op,sec,ren] = await Promise.all([
    q("SELECT * FROM brokers ORDER BY id"),
    q("SELECT * FROM developers ORDER BY id"),
    q("SELECT * FROM clients ORDER BY id"),
    q("SELECT * FROM offplan ORDER BY id DESC"),
    q("SELECT * FROM secondary ORDER BY id DESC"),
    q("SELECT * FROM rental ORDER BY id DESC"),
  ]);
  DATA.brokers    = b.map(r=>({...r}));
  DATA.developers = dev.map(r=>({...r}));
  DATA.clients    = c.map(r=>({...r}));
  DATA.offplan    = op.map(r=>({...r}));
  DATA.secondary  = sec.map(r=>({...r}));
  DATA.rental     = ren.map(r=>({...r}));
}

async function reload(table) {
  const rows = await q(`SELECT * FROM ${table} ORDER BY id ${table==="offplan"||table==="secondary"||table==="rental"?"DESC":""}`);
  DATA[table] = rows.map(r=>({...r}));
}

function show(id){ document.getElementById(id)?.classList.remove("hidden"); }
function hide(id){ document.getElementById(id)?.classList.add("hidden"); }

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doLogin = function() {
  const u = document.getElementById("li-user").value.trim();
  const p = document.getElementById("li-pass").value;
  const usr = USERS.find(x=>x.username===u&&x.password===p);
  if (!usr) { const e=document.getElementById("li-err"); e.textContent="Invalid credentials. Try admin / admin123"; e.classList.remove("hidden"); return; }
  CU = usr;
  hide("login-screen");
  buildApp();
  show("app");
};
document.getElementById("li-pass").addEventListener("keydown", e=>{ if(e.key==="Enter") window.doLogin(); });

window.logout = function() {
  CU=null; hide("app"); show("login-screen");
  document.getElementById("li-user").value=""; document.getElementById("li-pass").value="";
};

window.toggleSidebar = function() {
  sidebarOpen = !sidebarOpen;
  document.getElementById("sidebar").classList.toggle("collapsed", !sidebarOpen);
  document.querySelectorAll(".nav-label").forEach(el => el.classList.toggle("hidden",!sidebarOpen));
  document.querySelectorAll(".user-chip").forEach(el => el.classList.toggle("hidden",!sidebarOpen));
};

// â”€â”€â”€ BUILD APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildApp() {
  document.getElementById("topbar-date").textContent = new Date().toLocaleDateString("en-AE",{weekday:"long",year:"numeric",month:"long",day:"numeric"});
  document.getElementById("role-chip").textContent = CU.role;
  document.getElementById("role-chip").className = "chip " + (CU.role==="Admin"?"chip-blue":"chip-green");
  document.getElementById("avatar").textContent = CU.name[0];
  document.getElementById("user-chip").innerHTML = `<div class="uname">${esc(CU.name)}</div><div class="urole">${CU.role} Â· ğŸŸ¢ DB Live</div>`;
  const nav = document.getElementById("nav-items");
  nav.innerHTML = NAV.filter(n=>!n.admin||CU.role==="Admin").map(n=>`
    <button class="nav-btn${n.key===currentPage?" active":""}" data-page="${n.key}" onclick="goPage('${n.key}')">
      <span class="icon">${n.icon}</span><span class="nav-label">${n.label}</span>
    </button>`).join("");
  goPage(currentPage);
}

window.goPage = function(key) {
  currentPage = key;
  document.querySelectorAll(".nav-btn[data-page]").forEach(b=>b.classList.toggle("active",b.dataset.page===key));
  // destroy old charts
  Object.values(chartInstances).forEach(c=>c.destroy());
  chartInstances={};
  const pc = document.getElementById("page-content");
  pc.innerHTML = "";
  const pages = { dashboard:renderDashboard, brokers:renderBrokers, developers:renderDevelopers, clients:renderClients, offplan:renderOffplan, secondary:renderSecondary, rental:renderRental, reports:renderReports, settings:renderSettings };
  (pages[key]||renderDashboard)(pc);
};

// â”€â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(title, html) {
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-body").innerHTML = html;
  show("modal-overlay");
}
window.closeModal = function() { hide("modal-overlay"); };

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDashboard(pc) {
  const {brokers,developers,clients,offplan,secondary,rental} = DATA;
  const alerts=[];
  brokers.forEach(b=>{ if(daysUntil(b.reraExpiry)<=60) alerts.push(`âš ï¸ RERA expiring: ${b.name} (${b.reraExpiry})`); });
  rental.forEach(r=>{ if(daysUntil(r.endDate)<=90&&r.status==="Active") alerts.push(`ğŸ”” Renewal due: ${r.property} (ends ${r.endDate})`); });
  const totalComm = offplan.filter(d=>d.status==="Closed").reduce((s,d)=>s+commOP(d),0)
                  + secondary.filter(d=>d.status==="Closed").reduce((s,d)=>s+commSec(d),0)
                  + rental.reduce((s,d)=>s+commRT(d),0);
  const stats=[
    {l:"Total Commission",v:fmtAED(totalComm),gold:true},
    {l:"Total Brokers",v:brokers.length},{l:"Total Clients",v:clients.length},
    {l:"Developers",v:developers.length},{l:"Off Plan Deals",v:offplan.length},
    {l:"Secondary Deals",v:secondary.length},{l:"Rental Deals",v:rental.length},
    {l:"Active Alerts",v:alerts.length,gold:alerts.length>0},
  ];
  pc.innerHTML = `
    <div style="font-size:1.5rem;font-weight:800;margin-bottom:4px;color:var(--dark)">Dashboard</div>
    <div style="color:#64748b;font-size:.83rem;margin-bottom:16px">Welcome back, ${esc(CU.name)}</div>
    ${alerts.map(a=>`<div class="alert-bar">${esc(a)}</div>`).join("")}
    <div class="stat-grid">${stats.map(s=>`<div class="stat-card ${s.gold?"gold":"dark"}"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`).join("")}</div>
    <div class="chart-grid">
      <div class="card"><div style="font-weight:700;margin-bottom:14px">Monthly Revenue (AED)</div><div class="chart-wrap"><canvas id="ch-monthly"></canvas></div></div>
      <div class="card"><div style="font-weight:700;margin-bottom:14px">Deal Distribution</div><div class="chart-wrap"><canvas id="ch-pie"></canvas></div></div>
    </div>
    <div class="card"><div style="font-weight:700;margin-bottom:14px">Broker Performance</div><div style="height:150px"><canvas id="ch-broker"></canvas></div></div>`;

  const GOLD="#C9A84C";
  const monthly={labels:["Sep","Oct","Nov","Dec","Jan","Feb"],datasets:[{label:"Revenue",data:[280000,420000,510000,390000,620000,180000],borderColor:GOLD,backgroundColor:GOLD+"30",fill:true,tension:.4,pointBackgroundColor:GOLD}]};
  chartInstances.monthly = new Chart("ch-monthly",{type:"line",data:monthly,options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`AED ${fmt(c.raw)}`}}},scales:{y:{ticks:{callback:v=>`${v/1000}K`}}}}});

  const pie={labels:["Off Plan","Secondary","Rental"],datasets:[{data:[offplan.filter(d=>d.status==="Closed").length,secondary.filter(d=>d.status==="Closed").length,rental.length],backgroundColor:[GOLD,"#2563EB","#10b981"],borderWidth:2,borderColor:"#fff"}]};
  chartInstances.pie = new Chart("ch-pie",{type:"doughnut",data:pie,options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:"bottom",labels:{font:{size:11}}}}}});

  const bperf=brokers.map(b=>({ name:b.name.split(" ")[0], total: offplan.filter(d=>n(d.brokerId)===n(b.id)&&d.status==="Closed").reduce((s,d)=>s+commOP(d),0)+secondary.filter(d=>n(d.brokerId)===n(b.id)&&d.status==="Closed").reduce((s,d)=>s+commSec(d),0)+rental.filter(d=>n(d.brokerId)===n(b.id)).reduce((s,d)=>s+commRT(d),0) })).sort((a,b)=>b.total-a.total);
  chartInstances.broker = new Chart("ch-broker",{type:"bar",data:{labels:bperf.map(b=>b.name),datasets:[{label:"Commission",data:bperf.map(b=>b.total),backgroundColor:GOLD,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`AED ${fmt(c.raw)}`}}},scales:{y:{ticks:{callback:v=>`${v/1000}K`}}}}});
}

// â”€â”€â”€ BROKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBrokers(pc) {
  const rows = DATA.brokers;
  pc.innerHTML = `
    <div class="page-hdr"><div class="page-title">Brokers <small>(${rows.length})</small></div>${CU.role==="Admin"?`<button class="btn btn-primary" onclick="openBrokerForm(null)">+ Add Broker</button>`:""}</div>
    <div class="card">
      <div class="search-row"><div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-brokers" placeholder="Search brokersâ€¦" oninput="filterBrokers()"/></div></div>
      <div class="overflow"><table><thead><tr><th>Name</th><th>Nationality</th><th>Contact</th><th>RERA No.</th><th>RERA Expiry</th><th>Status</th><th>Alert</th><th>Actions</th></tr></thead>
      <tbody id="tbody-brokers">${brokerRows(rows)}</tbody></table></div>
    </div>`;
}
function brokerRows(rows) {
  return rows.map(b=>{ const d=daysUntil(b.reraExpiry); return `<tr>
    <td><b>${esc(b.name)}</b></td><td>${esc(b.nationality)}</td><td>${esc(b.contact)}</td>
    <td class="mono">${esc(b.rera)}</td><td>${esc(b.reraExpiry)}</td><td>${badge(b.status)}</td>
    <td>${d<=30?`<span style="color:#dc2626;font-weight:700;font-size:.78rem">ğŸ”´ ${d}d</span>`:d<=60?`<span style="color:#d97706;font-weight:700;font-size:.78rem">ğŸŸ¡ ${d}d</span>`:`<span style="color:#16a34a;font-size:.78rem">âœ… OK</span>`}</td>
    <td><button class="btn btn-edit" onclick='openBrokerForm(${b.id})'>âœï¸ Edit</button></td>
  </tr>`; }).join("") || `<tr><td colspan="8" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`;
}
window.filterBrokers = function() {
  const q2 = document.getElementById("q-brokers").value.toLowerCase();
  document.getElementById("tbody-brokers").innerHTML = brokerRows(DATA.brokers.filter(b=>b.name?.toLowerCase().includes(q2)));
};
window.openBrokerForm = function(id) {
  const b = id ? DATA.brokers.find(x=>n(x.id)===n(id)) : null;
  openModal(b?"Edit Broker â€” "+b.name:"Add Broker",`
    <div class="g2">
      <div class="field"><label>Full Name</label><input id="f-name" value="${esc(b?.name||"")}"/></div>
      <div class="field"><label>Nationality</label><input id="f-nat" value="${esc(b?.nationality||"")}"/></div>
      <div class="field"><label>Contact Number</label><input id="f-contact" value="${esc(b?.contact||"")}"/></div>
      <div class="field"><label>RERA Number</label><input id="f-rera" value="${esc(b?.rera||"")}"/></div>
      <div class="field"><label>RERA Expiry Date</label><input type="date" id="f-expiry" value="${esc(b?.reraExpiry||"")}"/></div>
      <div class="field"><label>Status</label><select id="f-status"><option ${b?.status==="Active"?"selected":""}>Active</option><option ${b?.status==="Inactive"?"selected":""}>Inactive</option></select></div>
    </div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('brokers',${id},'broker')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveBroker(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
};
window.saveBroker = async function(id) {
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  const vals=[g("f-name"),g("f-nat"),g("f-contact"),g("f-rera"),g("f-expiry"),g("f-status")];
  try {
    if(id) await q("UPDATE brokers SET name=?,nationality=?,contact=?,rera=?,reraExpiry=?,status=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO brokers (name,nationality,contact,rera,reraExpiry,status) VALUES (?,?,?,?,?,?)",vals);
    await reload("brokers"); closeModal(); renderBrokers(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ DEVELOPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDevelopers(pc) {
  const rows = DATA.developers;
  pc.innerHTML = `
    <div class="page-hdr"><div class="page-title">Developers <small>(${rows.length})</small></div>${CU.role==="Admin"?`<button class="btn btn-primary" onclick="openDevForm(null)">+ Add Developer</button>`:""}</div>
    <div class="card">
      <div class="search-row"><div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-dev" placeholder="Search developersâ€¦" oninput="filterDevs()"/></div></div>
      <div class="overflow"><table><thead><tr><th>Developer Name</th><th>Agreement Signed</th><th>Agreement Expiry</th><th>Status</th><th>Alert</th><th>Actions</th></tr></thead>
      <tbody id="tbody-devs">${devRows(rows)}</tbody></table></div>
    </div>`;
}
function devRows(rows){
  return rows.map(d=>{ const days=d.agreement==="Yes"?daysUntil(d.agreementExpiry):9999; return `<tr>
    <td><b>${esc(d.name)}</b></td><td>${badge(d.agreement)}</td><td>${esc(d.agreementExpiry)||"â€”"}</td><td>${badge(d.status)}</td>
    <td>${d.agreement==="Yes"?(days<=60?`<span style="color:#d97706;font-weight:700;font-size:.78rem">âš ï¸ ${days}d</span>`:`<span style="color:#16a34a;font-size:.78rem">âœ… OK</span>`):"â€”"}</td>
    <td><button class="btn btn-edit" onclick='openDevForm(${d.id})'>âœï¸ Edit</button></td>
  </tr>`; }).join("") || `<tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`;
}
window.filterDevs=function(){ const q2=document.getElementById("q-dev").value.toLowerCase(); document.getElementById("tbody-devs").innerHTML=devRows(DATA.developers.filter(d=>d.name?.toLowerCase().includes(q2))); };
window.openDevForm=function(id){
  const d=id?DATA.developers.find(x=>n(x.id)===n(id)):null;
  openModal(d?"Edit Developer â€” "+d.name:"Add Developer",`
    <div class="g2">
      <div class="field"><label>Developer Name</label><input id="f-name" value="${esc(d?.name||"")}"/></div>
      <div class="field"><label>Status</label><select id="f-status"><option ${d?.status==="Active"?"selected":""}>Active</option><option ${d?.status==="Inactive"?"selected":""}>Inactive</option></select></div>
      <div class="field"><label>Agreement Signed</label><select id="f-agree"><option ${d?.agreement==="Yes"?"selected":""}>Yes</option><option ${d?.agreement==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>Agreement Expiry</label><input type="date" id="f-expiry" value="${esc(d?.agreementExpiry||"")}"/></div>
    </div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('developers',${id},'developer')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveDev(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
};
window.saveDev=async function(id){
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  const vals=[g("f-name"),g("f-agree"),g("f-expiry"),g("f-status")];
  try {
    if(id) await q("UPDATE developers SET name=?,agreement=?,agreementExpiry=?,status=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO developers (name,agreement,agreementExpiry,status) VALUES (?,?,?,?)",vals);
    await reload("developers"); closeModal(); renderDevelopers(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ CLIENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderClients(pc){
  const rows=DATA.clients;
  pc.innerHTML=`
    <div class="page-hdr"><div class="page-title">Clients <small>(${rows.length})</small></div><button class="btn btn-primary" onclick="openClientForm(null)">+ Add Client</button></div>
    <div class="card">
      <div class="search-row">
        <div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-cl" placeholder="Search clientsâ€¦" oninput="filterClients()"/></div>
        <select id="tf-cl" style="width:160px" onchange="filterClients()"><option>All</option><option>Buyer</option><option>Seller</option><option>Tenant</option><option>Landlord</option></select>
      </div>
      <div class="overflow"><table><thead><tr><th>Name</th><th>Nationality</th><th>Contact</th><th>Email</th><th>Type</th><th>Actions</th></tr></thead>
      <tbody id="tbody-cl">${clientRows(rows)}</tbody></table></div>
    </div>`;
}
function clientRows(rows){ return rows.map(c=>`<tr><td><b>${esc(c.name)}</b></td><td>${esc(c.nationality)}</td><td>${esc(c.contact)}</td><td>${esc(c.email)}</td><td>${badge(c.type)}</td><td><button class="btn btn-edit" onclick='openClientForm(${c.id})'>âœï¸ Edit</button></td></tr>`).join("")||`<tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`; }
window.filterClients=function(){ const qv=(document.getElementById("q-cl")?.value||"").toLowerCase(); const tf=document.getElementById("tf-cl")?.value||"All"; document.getElementById("tbody-cl").innerHTML=clientRows(DATA.clients.filter(c=>(tf==="All"||c.type===tf)&&(c.name?.toLowerCase().includes(qv)||c.email?.toLowerCase().includes(qv)))); };
window.openClientForm=function(id){
  const c=id?DATA.clients.find(x=>n(x.id)===n(id)):null;
  openModal(c?"Edit Client â€” "+c.name:"Add Client",`
    <div class="g2">
      <div class="field"><label>Full Name</label><input id="f-name" value="${esc(c?.name||"")}"/></div>
      <div class="field"><label>Nationality</label><input id="f-nat" value="${esc(c?.nationality||"")}"/></div>
      <div class="field"><label>Contact Number</label><input id="f-contact" value="${esc(c?.contact||"")}"/></div>
      <div class="field"><label>Email</label><input type="email" id="f-email" value="${esc(c?.email||"")}"/></div>
      <div class="field"><label>Client Type</label><select id="f-type"><option ${c?.type==="Buyer"?"selected":""}>Buyer</option><option ${c?.type==="Seller"?"selected":""}>Seller</option><option ${c?.type==="Tenant"?"selected":""}>Tenant</option><option ${c?.type==="Landlord"?"selected":""}>Landlord</option></select></div>
    </div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('clients',${id},'client')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveClient(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
};
window.saveClient=async function(id){
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  const vals=[g("f-name"),g("f-nat"),g("f-contact"),g("f-email"),g("f-type")];
  try {
    if(id) await q("UPDATE clients SET name=?,nationality=?,contact=?,email=?,type=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO clients (name,nationality,contact,email,type) VALUES (?,?,?,?,?)",vals);
    await reload("clients"); closeModal(); renderClients(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ OFF PLAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOffplan(pc){
  const raw = CU.role==="Broker"?DATA.offplan.filter(d=>n(d.brokerId)===CU.brokerId):DATA.offplan;
  pc.innerHTML=`
    <div class="page-hdr"><div class="page-title">Off Plan Deals <small>(${raw.length})</small></div>${CU.role==="Admin"?`<button class="btn btn-primary" onclick="openOPForm(null)">+ Add Deal</button>`:""}</div>
    <div class="card">
      <div class="search-row">
        <div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-op" placeholder="Search project, unitâ€¦" oninput="filterOP()"/></div>
        <select id="sf-op" style="width:160px" onchange="filterOP()"><option>All</option><option>Pending</option><option>Closed</option><option>Cancelled</option></select>
      </div>
      <div class="overflow"><table><thead><tr><th>ID</th><th>Broker</th><th>Client</th><th>Project</th><th>Unit</th><th>Developer</th><th>Price (AED)</th><th>Comm%</th><th>Commission</th><th>Date</th><th>Status</th><th>AML</th><th>KYC</th><th>Actions</th></tr></thead>
      <tbody id="tbody-op">${opRows(raw)}</tbody></table></div>
    </div>`;
}
function bName(id){ return DATA.brokers.find(b=>n(b.id)===n(id))?.name||"â€”"; }
function cName(id){ return DATA.clients.find(c=>n(c.id)===n(id))?.name||"â€”"; }
function dName(id){ return DATA.developers.find(d=>n(d.id)===n(id))?.name||"â€”"; }
function opRows(rows){ return rows.map(d=>`<tr>
  <td class="mono">${id3("OP",d.id)}</td><td>${esc(bName(d.brokerId))}</td><td>${esc(cName(d.clientId))}</td>
  <td><b>${esc(d.project)}</b></td><td>${esc(d.unit)}</td><td>${esc(dName(d.developerId))}</td>
  <td style="font-weight:600">${fmt(d.price)}</td><td>${d.commPct}%</td><td style="color:var(--gold);font-weight:700">${fmt(commOP(d))}</td>
  <td>${esc(d.date)}</td><td>${badge(d.status)}</td><td>${badge(d.aml)}</td><td>${badge(d.kycReceived)}</td>
  <td style="white-space:nowrap"><button class="btn btn-ghost" onclick='viewOP(${d.id})' style="padding:5px 10px">ğŸ‘</button> <button class="btn btn-edit" onclick='openOPForm(${d.id})'>âœï¸ Edit</button></td>
</tr>`).join("")||`<tr><td colspan="14" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`; }
window.filterOP=function(){ const qv=(document.getElementById("q-op")?.value||"").toLowerCase(); const sf=document.getElementById("sf-op")?.value||"All"; const raw=CU.role==="Broker"?DATA.offplan.filter(d=>n(d.brokerId)===CU.brokerId):DATA.offplan; document.getElementById("tbody-op").innerHTML=opRows(raw.filter(d=>(sf==="All"||d.status===sf)&&(d.project?.toLowerCase().includes(qv)||d.unit?.toLowerCase().includes(qv)))); };
window.viewOP=function(id){ const d=DATA.offplan.find(x=>n(x.id)===n(id)); if(!d)return; openModal(`Off Plan â€” ${d.project}`, viewGrid([["Deal ID",id3("OP",d.id)],["Project",d.project],["Unit",d.unit],["Developer",dName(d.developerId)],["Broker",bName(d.brokerId)],["Client",cName(d.clientId)],["Price",fmtAED(d.price)],["Comm %",d.commPct+"%"],["Commission",fmtAED(commOP(d))],["Date",d.date],["Invoice",d.invoiceNo||"â€”"],["Status",d.status],["AML",d.aml],["KYC Sent",d.kycSent],["KYC Received",d.kycReceived]])+`${d.notes?`<div class="note-box"><b>Notes:</b> ${esc(d.notes)}</div>`:""}<div class="save-bar"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`); };
window.openOPForm=function(id){
  const d=id?DATA.offplan.find(x=>n(x.id)===n(id)):null;
  const bOpts=DATA.brokers.map(b=>`<option value="${b.id}" ${n(d?.brokerId)===n(b.id)?"selected":""}>${esc(b.name)}</option>`).join("");
  const cOpts=DATA.clients.map(c=>`<option value="${c.id}" ${n(d?.clientId)===n(c.id)?"selected":""}>${esc(c.name)}</option>`).join("");
  const devOpts=DATA.developers.map(x=>`<option value="${x.id}" ${n(d?.developerId)===n(x.id)?"selected":""}>${esc(x.name)}</option>`).join("");
  openModal(d?`Edit Off Plan â€” ${d.project}`:"Add Off Plan Deal",`
    <div class="g2">
      <div class="field"><label>Project Name</label><input id="f-project" value="${esc(d?.project||"")}"/></div>
      <div class="field"><label>Unit No.</label><input id="f-unit" value="${esc(d?.unit||"")}"/></div>
      <div class="field"><label>Broker</label><select id="f-broker">${bOpts}</select></div>
      <div class="field"><label>Client</label><select id="f-client">${cOpts}</select></div>
      <div class="field"><label>Developer</label><select id="f-dev">${devOpts}</select></div>
      <div class="field"><label>Purchase Price (AED)</label><input type="number" id="f-price" value="${d?.price||""}"/></div>
      <div class="field"><label>Commission %</label><input type="number" step="0.1" id="f-comm" value="${d?.commPct||""}" oninput="calcOPComm()"/></div>
      <div class="field"><label>Date of Sale</label><input type="date" id="f-date" value="${esc(d?.date||"")}"/></div>
      <div class="field"><label>Invoice No.</label><input id="f-inv" value="${esc(d?.invoiceNo||"")}"/></div>
      <div class="field"><label>Status</label><select id="f-status"><option ${d?.status==="Pending"?"selected":""}>Pending</option><option ${d?.status==="Closed"?"selected":""}>Closed</option><option ${d?.status==="Cancelled"?"selected":""}>Cancelled</option></select></div>
      <div class="field"><label>AML Screening</label><select id="f-aml"><option ${d?.aml==="Yes"?"selected":""}>Yes</option><option ${d?.aml==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>KYC Sent</label><select id="f-kycs"><option ${d?.kycSent==="Yes"?"selected":""}>Yes</option><option ${d?.kycSent==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>KYC Received</label><select id="f-kycr"><option ${d?.kycReceived==="Yes"?"selected":""}>Yes</option><option ${d?.kycReceived==="No"?"selected":""}>No</option></select></div>
    </div>
    <div style="margin-top:14px"><div class="field"><label>Notes</label><textarea id="f-notes" style="height:60px;resize:vertical">${esc(d?.notes||"")}</textarea></div></div>
    <div class="comm-box">Auto-calculated Commission: <span id="op-comm-preview">${fmtAED(d?commOP(d):0)}</span></div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('offplan',${id},'off plan deal')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveOP(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
  document.getElementById("f-price").addEventListener("input",calcOPComm);
};
window.calcOPComm=function(){ const p=n(document.getElementById("f-price")?.value); const c=n(document.getElementById("f-comm")?.value); const el=document.getElementById("op-comm-preview"); if(el)el.textContent=fmtAED(p*c/100); };
window.saveOP=async function(id){
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  try {
    const vals=[g("f-broker"),g("f-client"),g("f-dev"),g("f-status"),g("f-project"),g("f-unit"),n(g("f-price")),n(g("f-comm")),g("f-inv"),g("f-date"),g("f-aml"),g("f-kycs"),g("f-kycr"),g("f-notes")];
    if(id) await q("UPDATE offplan SET brokerId=?,clientId=?,developerId=?,status=?,project=?,unit=?,price=?,commPct=?,invoiceNo=?,date=?,aml=?,kycSent=?,kycReceived=?,notes=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO offplan (brokerId,clientId,developerId,status,project,unit,price,commPct,invoiceNo,date,aml,kycSent,kycReceived,notes) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)",vals);
    await reload("offplan"); closeModal(); renderOffplan(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ SECONDARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSecondary(pc){
  const raw=CU.role==="Broker"?DATA.secondary.filter(d=>n(d.brokerId)===CU.brokerId):DATA.secondary;
  pc.innerHTML=`
    <div class="page-hdr"><div class="page-title">Secondary (Resale) Deals <small>(${raw.length})</small></div>${CU.role==="Admin"?`<button class="btn btn-primary" onclick="openSEForm(null)">+ Add Deal</button>`:""}</div>
    <div class="card">
      <div class="search-row"><div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-se" placeholder="Search propertyâ€¦" oninput="filterSE()"/></div></div>
      <div class="overflow"><table><thead><tr><th>ID</th><th>Broker</th><th>Buyer</th><th>Seller</th><th>Property</th><th>Price (AED)</th><th>Seller Comm</th><th>Buyer Comm</th><th>Discount</th><th>Total Comm</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="tbody-se">${seRows(raw)}</tbody></table></div>
    </div>`;
}
function seRows(rows){ return rows.map(d=>`<tr>
  <td class="mono">${id3("SE",d.id)}</td><td>${esc(bName(d.brokerId))}</td><td>${esc(cName(d.buyerId))}</td><td>${esc(cName(d.sellerId))}</td>
  <td><b>${esc(d.property)}</b></td><td style="font-weight:600">${fmt(d.price)}</td>
  <td>${fmt(commSel(d))}</td><td>${fmt(commBuy(d))}</td><td>${d.discount?fmt(d.discount):"â€”"}</td>
  <td style="color:var(--gold);font-weight:700">${fmt(commSec(d))}</td>
  <td>${esc(d.date)}</td><td>${badge(d.status)}</td>
  <td style="white-space:nowrap"><button class="btn btn-ghost" onclick='viewSE(${d.id})' style="padding:5px 10px">ğŸ‘</button> <button class="btn btn-edit" onclick='openSEForm(${d.id})'>âœï¸ Edit</button></td>
</tr>`).join("")||`<tr><td colspan="13" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`; }
window.filterSE=function(){ const qv=(document.getElementById("q-se")?.value||"").toLowerCase(); const raw=CU.role==="Broker"?DATA.secondary.filter(d=>n(d.brokerId)===CU.brokerId):DATA.secondary; document.getElementById("tbody-se").innerHTML=seRows(raw.filter(d=>d.property?.toLowerCase().includes(qv))); };
window.viewSE=function(id){ const d=DATA.secondary.find(x=>n(x.id)===n(id)); if(!d)return; openModal(`Resale â€” ${d.property}`,viewGrid([["ID",id3("SE",d.id)],["Property",d.property],["Prop No.",d.propNo],["Contract",d.contract],["Broker",bName(d.brokerId)],["Buyer",cName(d.buyerId)],["Seller",cName(d.sellerId)],["Price",fmtAED(d.price)],["Seller Comm %",d.sellerPct+"%"],["Buyer Comm %",d.buyerPct+"%"],["Discount",d.discount?fmtAED(d.discount):"None"],["Seller Comm",fmtAED(commSel(d))],["Buyer Comm",fmtAED(commBuy(d))],["Total Comm",fmtAED(commSec(d))],["AML Buyer",d.amlBuyer],["AML Seller",d.amlSeller],["KYC Sent",d.kycSent],["KYC Received",d.kycReceived],["Invoice No.",d.invoiceNo||"â€”"],["Status",d.status]])+`<div class="save-bar"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`); };
window.openSEForm=function(id){
  const d=id?DATA.secondary.find(x=>n(x.id)===n(id)):null;
  const bOpts=DATA.brokers.map(b=>`<option value="${b.id}" ${n(d?.brokerId)===n(b.id)?"selected":""}>${esc(b.name)}</option>`).join("");
  const cOpts=DATA.clients.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");
  const buyOpts=DATA.clients.map(c=>`<option value="${c.id}" ${n(d?.buyerId)===n(c.id)?"selected":""}>${esc(c.name)}</option>`).join("");
  const selOpts=DATA.clients.map(c=>`<option value="${c.id}" ${n(d?.sellerId)===n(c.id)?"selected":""}>${esc(c.name)}</option>`).join("");
  openModal(d?`Edit Resale â€” ${d.property}`:"Add Resale Deal",`
    <div class="g2">
      <div class="field"><label>Property Name</label><input id="f-prop" value="${esc(d?.property||"")}"/></div>
      <div class="field"><label>Property No.</label><input id="f-propno" value="${esc(d?.propNo||"")}"/></div>
      <div class="field"><label>Contract No.</label><input id="f-contract" value="${esc(d?.contract||"")}"/></div>
      <div class="field"><label>Broker</label><select id="f-broker">${bOpts}</select></div>
      <div class="field"><label>Buyer</label><select id="f-buyer">${buyOpts}</select></div>
      <div class="field"><label>Seller</label><select id="f-seller">${selOpts}</select></div>
      <div class="field"><label>Purchase Price (AED)</label><input type="number" id="f-price" value="${d?.price||""}" oninput="calcSEComm()"/></div>
      <div class="field"><label>Seller Comm %</label><input type="number" step="0.1" id="f-sellpct" value="${d?.sellerPct||""}" oninput="calcSEComm()"/></div>
      <div class="field"><label>Buyer Comm %</label><input type="number" step="0.1" id="f-buypct" value="${d?.buyerPct||""}" oninput="calcSEComm()"/></div>
      <div class="field"><label>Discount (AED)</label><input type="number" id="f-disc" value="${d?.discount||0}" oninput="calcSEComm()"/></div>
      <div class="field"><label>Date of Sale</label><input type="date" id="f-date" value="${esc(d?.date||"")}"/></div>
      <div class="field"><label>Invoice No.</label><input id="f-inv" value="${esc(d?.invoiceNo||"")}"/></div>
      <div class="field"><label>Status</label><select id="f-status"><option ${d?.status==="Pending"?"selected":""}>Pending</option><option ${d?.status==="Closed"?"selected":""}>Closed</option><option ${d?.status==="Cancelled"?"selected":""}>Cancelled</option></select></div>
      <div class="field"><label>AML Buyer</label><select id="f-amlb"><option ${d?.amlBuyer==="Yes"?"selected":""}>Yes</option><option ${d?.amlBuyer==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>AML Seller</label><select id="f-amls"><option ${d?.amlSeller==="Yes"?"selected":""}>Yes</option><option ${d?.amlSeller==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>KYC Sent</label><select id="f-kycs"><option ${d?.kycSent==="Yes"?"selected":""}>Yes</option><option ${d?.kycSent==="No"?"selected":""}>No</option></select></div>
      <div class="field"><label>KYC Received</label><select id="f-kycr"><option ${d?.kycReceived==="Yes"?"selected":""}>Yes</option><option ${d?.kycReceived==="No"?"selected":""}>No</option></select></div>
    </div>
    <div class="comm-box">Auto-calculated Total Commission: <span id="se-comm-preview">${fmtAED(d?commSec(d):0)}</span></div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('secondary',${id},'secondary deal')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveSE(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
};
window.calcSEComm=function(){ const p=n(gv("f-price")); const s=n(gv("f-sellpct")); const b2=n(gv("f-buypct")); const disc=n(gv("f-disc")); const el=document.getElementById("se-comm-preview"); if(el)el.textContent=fmtAED(p*s/100+p*b2/100-disc); };
window.saveSE=async function(id){
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  try {
    const vals=[g("f-broker"),g("f-buyer"),g("f-seller"),1,g("f-status"),g("f-prop"),g("f-propno"),g("f-contract"),n(g("f-price")),n(g("f-sellpct")),n(g("f-buypct")),n(g("f-disc")),g("f-inv"),g("f-date"),g("f-amlb"),g("f-amls"),g("f-kycs"),g("f-kycr")];
    if(id) await q("UPDATE secondary SET brokerId=?,buyerId=?,sellerId=?,developerId=?,status=?,property=?,propNo=?,contract=?,price=?,sellerPct=?,buyerPct=?,discount=?,invoiceNo=?,date=?,amlBuyer=?,amlSeller=?,kycSent=?,kycReceived=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO secondary (brokerId,buyerId,sellerId,developerId,status,property,propNo,contract,price,sellerPct,buyerPct,discount,invoiceNo,date,amlBuyer,amlSeller,kycSent,kycReceived) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",vals);
    await reload("secondary"); closeModal(); renderSecondary(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ RENTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRental(pc){
  const raw=CU.role==="Broker"?DATA.rental.filter(d=>n(d.brokerId)===CU.brokerId):DATA.rental;
  pc.innerHTML=`
    <div class="page-hdr"><div class="page-title">Rental Deals <small>(${raw.length})</small></div>${CU.role==="Admin"?`<button class="btn btn-primary" onclick="openREForm(null)">+ Add Deal</button>`:""}</div>
    <div class="card">
      <div class="search-row">
        <div class="search-wrap"><span class="icon">ğŸ”</span><input id="q-re" placeholder="Search propertyâ€¦" oninput="filterRE()"/></div>
        <select id="sf-re" style="width:160px" onchange="filterRE()"><option>All</option><option>Active</option><option>Expired</option><option>Renewed</option></select>
      </div>
      <div class="overflow"><table><thead><tr><th>ID</th><th>Broker</th><th>Client</th><th>Property</th><th>Type</th><th>Rent</th><th>Comm%</th><th>Comm</th><th>VAT 5%</th><th>Total w/VAT</th><th>End Date</th><th>Renewal</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="tbody-re">${reRows(raw)}</tbody></table></div>
    </div>`;
}
function reRows(rows){ return rows.map(d=>{ const days=daysUntil(d.endDate); return `<tr>
  <td class="mono">${id3("RE",d.id)}</td><td>${esc(bName(d.brokerId))}</td><td>${esc(cName(d.clientId))}</td>
  <td><b>${esc(d.property)}</b></td><td>${esc(d.contractType)}</td>
  <td style="font-weight:600">${fmt(d.rent)}</td><td>${d.commPct}%</td><td>${fmt(commR(d))}</td><td>${fmt(commVAT(d))}</td>
  <td style="color:var(--gold);font-weight:700">${fmt(commRT(d))}</td>
  <td>${esc(d.endDate)}</td>
  <td>${days<=90?`<span style="color:#d97706;font-weight:700;font-size:.78rem">âš ï¸ ${days}d</span>`:`<span style="font-size:.78rem;color:#64748b">${renewalDate(d)}</span>`}</td>
  <td>${badge(d.status)}</td>
  <td style="white-space:nowrap"><button class="btn btn-ghost" onclick='viewRE(${d.id})' style="padding:5px 10px">ğŸ‘</button> <button class="btn btn-edit" onclick='openREForm(${d.id})'>âœï¸ Edit</button></td>
</tr>`; }).join("")||`<tr><td colspan="14" style="text-align:center;color:#94a3b8;padding:24px">No records</td></tr>`; }
window.filterRE=function(){ const qv=(document.getElementById("q-re")?.value||"").toLowerCase(); const sf=document.getElementById("sf-re")?.value||"All"; const raw=CU.role==="Broker"?DATA.rental.filter(d=>n(d.brokerId)===CU.brokerId):DATA.rental; document.getElementById("tbody-re").innerHTML=reRows(raw.filter(d=>(sf==="All"||d.status===sf)&&d.property?.toLowerCase().includes(qv))); };
window.viewRE=function(id){ const d=DATA.rental.find(x=>n(x.id)===n(id)); if(!d)return; openModal(`Rental â€” ${d.property}`,viewGrid([["ID",id3("RE",d.id)],["Property",d.property],["Prop No.",d.propNo],["Contract Type",d.contractType],["Broker",bName(d.brokerId)],["Client",cName(d.clientId)],["Rent",fmtAED(d.rent)],["Comm %",d.commPct+"%"],["Commission",fmtAED(commR(d))],["VAT (5%)",fmtAED(commVAT(d))],["Total w/VAT",fmtAED(commRT(d))],["Date Rented",d.dateRented],["Start Date",d.startDate],["End Date",d.endDate],["Renewal Date",renewalDate(d)],["Invoice No.",d.invoiceNo||"â€”"],["PF Expert",d.pfExpert],["Status",d.status]])+`${d.notes?`<div class="note-box"><b>Notes:</b> ${esc(d.notes)}</div>`:""}<div class="save-bar"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>`); };
window.openREForm=function(id){
  const d=id?DATA.rental.find(x=>n(x.id)===n(id)):null;
  const bOpts=DATA.brokers.map(b=>`<option value="${b.id}" ${n(d?.brokerId)===n(b.id)?"selected":""}>${esc(b.name)}</option>`).join("");
  const cOpts=DATA.clients.map(c=>`<option value="${c.id}" ${n(d?.clientId)===n(c.id)?"selected":""}>${esc(c.name)}</option>`).join("");
  openModal(d?`Edit Rental â€” ${d.property}`:"Add Rental Deal",`
    <div class="g2">
      <div class="field"><label>Property Name</label><input id="f-prop" value="${esc(d?.property||"")}"/></div>
      <div class="field"><label>Property No.</label><input id="f-propno" value="${esc(d?.propNo||"")}"/></div>
      <div class="field"><label>Broker</label><select id="f-broker">${bOpts}</select></div>
      <div class="field"><label>Client</label><select id="f-client">${cOpts}</select></div>
      <div class="field"><label>Contract Type</label><select id="f-ctype"><option ${d?.contractType==="Annual"?"selected":""}>Annual</option><option ${d?.contractType==="Short Term"?"selected":""}>Short Term</option></select></div>
      <div class="field"><label>Rent Amount (AED)</label><input type="number" id="f-rent" value="${d?.rent||""}" oninput="calcREComm()"/></div>
      <div class="field"><label>Commission %</label><input type="number" step="0.1" id="f-comm" value="${d?.commPct||""}" oninput="calcREComm()"/></div>
      <div class="field"><label>Invoice No.</label><input id="f-inv" value="${esc(d?.invoiceNo||"")}"/></div>
      <div class="field"><label>Date Rented</label><input type="date" id="f-dater" value="${esc(d?.dateRented||"")}"/></div>
      <div class="field"><label>Contract Start Date</label><input type="date" id="f-start" value="${esc(d?.startDate||"")}"/></div>
      <div class="field"><label>Contract End Date</label><input type="date" id="f-end" value="${esc(d?.endDate||"")}"/></div>
      <div class="field"><label>Status</label><select id="f-status"><option ${d?.status==="Active"?"selected":""}>Active</option><option ${d?.status==="Expired"?"selected":""}>Expired</option><option ${d?.status==="Renewed"?"selected":""}>Renewed</option></select></div>
      <div class="field"><label>PF Expert Transaction</label><select id="f-pf"><option ${d?.pfExpert==="Yes"?"selected":""}>Yes</option><option ${d?.pfExpert==="No"?"selected":""}>No</option></select></div>
    </div>
    <div style="margin-top:14px"><div class="field"><label>Notes</label><textarea id="f-notes" style="height:60px;resize:vertical">${esc(d?.notes||"")}</textarea></div></div>
    <div class="comm-box">Auto-calculated Total (incl. VAT 5%): <span id="re-comm-preview">${fmtAED(d?commRT(d):0)}</span></div>
    <div class="save-bar">
      ${id ? `<button class="btn btn-delete" onclick="deleteRecord('rental',${id},'rental deal')" style="margin-right:auto">ğŸ—‘ï¸ Delete</button>` : ''}
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="save-btn" onclick="saveRE(${id||0})">ğŸ’¾ Save Changes</button>
    </div>`);
};
window.calcREComm=function(){ const r=n(gv("f-rent")); const c=n(gv("f-comm")); const el=document.getElementById("re-comm-preview"); if(el)el.textContent=fmtAED(r*c/100*1.05); };
window.saveRE=async function(id){
  const btn=document.getElementById("save-btn"); btn.disabled=true; btn.textContent="Savingâ€¦";
  try {
    const vals=[g("f-broker"),g("f-client"),g("f-status"),g("f-prop"),g("f-propno"),g("f-ctype"),n(g("f-rent")),n(g("f-comm")),g("f-inv"),g("f-dater"),g("f-start"),g("f-end"),g("f-pf"),g("f-notes")];
    if(id) await q("UPDATE rental SET brokerId=?,clientId=?,status=?,property=?,propNo=?,contractType=?,rent=?,commPct=?,invoiceNo=?,dateRented=?,startDate=?,endDate=?,pfExpert=?,notes=? WHERE id=?",[...vals,id]);
    else   await q("INSERT INTO rental (brokerId,clientId,status,property,propNo,contractType,rent,commPct,invoiceNo,dateRented,startDate,endDate,pfExpert,notes) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)",vals);
    await reload("rental"); closeModal(); renderRental(document.getElementById("page-content"));
  } catch(e){ alert("Error: "+e.message); } finally{ btn.disabled=false; }
};

// â”€â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderReports(pc){
  const list=CU.role==="Broker"?DATA.brokers.filter(b=>n(b.id)===CU.brokerId):DATA.brokers;
  pc.innerHTML=`<div class="page-title" style="margin-bottom:20px">Commission Reports</div>`+list.map(b=>{
    const opD=DATA.offplan.filter(d=>n(d.brokerId)===n(b.id)&&d.status==="Closed");
    const seD=DATA.secondary.filter(d=>n(d.brokerId)===n(b.id)&&d.status==="Closed");
    const reD=DATA.rental.filter(d=>n(d.brokerId)===n(b.id));
    const opC=opD.reduce((s,d)=>s+commOP(d),0),seC=seD.reduce((s,d)=>s+commSec(d),0),reC=reD.reduce((s,d)=>s+commRT(d),0);
    return `<div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div><div style="font-weight:700;font-size:1.05rem">${esc(b.name)}</div><div style="font-size:.79rem;color:#64748b">RERA: ${esc(b.rera)} Â· ${esc(b.nationality)}</div></div>
        <div style="text-align:right"><div style="font-size:1.4rem;font-weight:800;color:var(--gold)">${fmtAED(opC+seC+reC)}</div><div style="font-size:.74rem;color:#64748b">Total Commission</div></div>
      </div>
      <div class="g3" style="margin-bottom:${opD.length?16:0}px">
        ${[["ğŸ— Off Plan",opC,opD.length],["ğŸ”„ Secondary",seC,seD.length],["ğŸ  Rental",reC,reD.length]].map(([lbl,comm,cnt])=>`<div style="background:#f8fafc;border-radius:10px;padding:12px 14px;border:1px solid #e4ebf5"><div style="font-size:.74rem;color:#64748b;font-weight:700;margin-bottom:4px">${lbl}</div><div style="font-weight:700">${fmtAED(comm)}</div><div style="font-size:.76rem;color:#94a3b8;margin-top:2px">${cnt} deals</div></div>`).join("")}
      </div>
      ${opD.length?`<div class="overflow"><table><thead><tr><th>Project</th><th>Unit</th><th>Price (AED)</th><th>Comm %</th><th>Commission (AED)</th><th>Date</th></tr></thead><tbody>${opD.map(d=>`<tr><td>${esc(d.project)}</td><td>${esc(d.unit)}</td><td style="font-weight:600">${fmt(d.price)}</td><td>${d.commPct}%</td><td style="color:var(--gold);font-weight:700">${fmt(commOP(d))}</td><td>${esc(d.date)}</td></tr>`).join("")}</tbody></table></div>`:""}
    </div>`;
  }).join("");
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSettings(pc){
  pc.innerHTML=`<div class="page-title" style="margin-bottom:20px">Settings</div>
  <div class="card" style="max-width:560px">
    <div style="font-weight:700;margin-bottom:6px">Company Configuration</div>
    <div style="font-size:.8rem;color:#16a34a;background:#dcfce7;padding:8px 12px;border-radius:7px;margin-bottom:16px;display:inline-block">ğŸŸ¢ Connected Â· nasama-db2-alaithan.aws-ap-northeast-1.turso.io</div>
    <div class="g2" style="margin-bottom:18px">
      ${[["Company Name","Nasama Properties Real Estate","text"],["Location","Dubai, UAE","text"],["Default Currency","AED","text"],["VAT Rate (%)","5","number"],["RERA Alert (days before)","60","number"],["Renewal Reminder (days before)","90","number"]].map(([l,v,t])=>`<div class="field"><label>${l}</label><input type="${t}" value="${v}"/></div>`).join("")}
    </div>
    <button class="btn btn-primary" style="padding:10px 20px">ğŸ’¾ Save Settings</button>
  </div>`;
}

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const g   = id => document.getElementById(id)?.value ?? "";
const gv  = id => document.getElementById(id)?.value ?? "";
function viewGrid(items){ return `<div class="view-grid">${items.map(([k,v])=>`<div class="view-cell"><div class="vk">${esc(k)}</div><div class="vv">${esc(String(v))}</div></div>`).join("")}</div>`; }

// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.deleteRecord = async function(table, id, label) {
  if (!confirm('Are you sure you want to delete this ' + label + '? This cannot be undone.')) return;
  const renderMap = {
    brokers:    () => renderBrokers(document.getElementById('page-content')),
    developers: () => renderDevelopers(document.getElementById('page-content')),
    clients:    () => renderClients(document.getElementById('page-content')),
    offplan:    () => renderOffplan(document.getElementById('page-content')),
    secondary:  () => renderSecondary(document.getElementById('page-content')),
    rental:     () => renderRental(document.getElementById('page-content')),
  };
  try {
    await q(`DELETE FROM ${table} WHERE id=${id}`);
    await reload(table);
    closeModal();
    renderMap[table]();
  } catch(e) {
    alert('Delete failed: ' + e.message);
  }
};
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
